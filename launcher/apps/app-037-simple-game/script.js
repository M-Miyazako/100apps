class NumberGuessingGame {
    constructor() {
        this.gameState = {
            secretNumber: null,
            minRange: 1,
            maxRange: 100,
            maxAttempts: 10,
            currentAttempts: 0,
            remainingAttempts: 10,
            isGameActive: false,
            guessHistory: [],
            totalGames: 0,
            totalWins: 0,
            leaderboard: [],
            difficulty: 'normal',
            hints: []
        };
        
        this.difficulties = {
            easy: { max: 50, attempts: 15 },
            normal: { max: 100, attempts: 10 },
            hard: { max: 200, attempts: 8 },
            expert: { max: 500, attempts: 12 }
        };
        
        this.initializeElements();
        this.bindEvents();
        this.loadGameData();
        this.updateDisplay();
        this.updateSettings();
    }
    
    initializeElements() {
        this.elements = {
            // Ë®≠ÂÆöË¶ÅÁ¥†
            minRange: document.getElementById('minRange'),
            maxRange: document.getElementById('maxRange'),
            maxAttempts: document.getElementById('maxAttempts'),
            difficulty: document.getElementById('difficulty'),
            startBtn: document.getElementById('startBtn'),
            
            // „Ç≤„Éº„É†Áä∂ÊÖãË°®Á§∫
            currentAttempts: document.getElementById('currentAttempts'),
            remainingAttempts: document.getElementById('remainingAttempts'),
            totalWins: document.getElementById('totalWins'),
            totalGames: document.getElementById('totalGames'),
            winRate: document.getElementById('winRate'),
            rangeDisplay: document.getElementById('rangeDisplay'),
            
            // „Ç≤„Éº„É†ÂÖ•Âäõ
            guessInput: document.getElementById('guessInput'),
            guessBtn: document.getElementById('guessBtn'),
            
            // „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
            feedback: document.getElementById('feedback'),
            hintArea: document.getElementById('hintArea'),
            
            // Â±•Ê≠¥„Å®„É™„Éº„ÉÄ„Éº„Éú„Éº„Éâ
            historyList: document.getElementById('historyList'),
            leaderboardList: document.getElementById('leaderboardList'),
            clearHistoryBtn: document.getElementById('clearHistory'),
            
            // „É¢„Éº„ÉÄ„É´
            gameOverModal: document.getElementById('gameOverModal'),
            gameOverTitle: document.getElementById('gameOverTitle'),
            gameResult: document.getElementById('gameResult'),
            playAgainBtn: document.getElementById('playAgainBtn'),
            closeModalBtn: document.getElementById('closeModalBtn'),
            
            // „Ç≤„Éº„É†ÁîªÈù¢
            gamePanel: document.getElementById('gamePanel'),
            gameStatus: document.getElementById('gameStatus')
        };
    }
    
    bindEvents() {
        // „Ç≤„Éº„É†Âà∂Âæ°
        this.elements.startBtn.addEventListener('click', () => this.startGame());
        this.elements.guessBtn.addEventListener('click', () => this.makeGuess());
        this.elements.playAgainBtn.addEventListener('click', () => this.playAgain());
        this.elements.closeModalBtn.addEventListener('click', () => this.closeModal());
        
        // ÂÖ•Âäõ„Ç§„Éô„É≥„Éà
        this.elements.guessInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') this.makeGuess();
        });
        
        // Ë®≠ÂÆöÂ§âÊõ¥
        this.elements.minRange.addEventListener('change', () => this.updateRangeSettings());
        this.elements.maxRange.addEventListener('change', () => this.updateRangeSettings());
        this.elements.maxAttempts.addEventListener('change', () => this.updateAttemptSettings());
        this.elements.difficulty.addEventListener('change', () => this.changeDifficulty());
        
        // ÂÖ•ÂäõÊ§úË®º
        this.elements.guessInput.addEventListener('input', () => this.validateInput());
        
        // Â±•Ê≠¥„ÇØ„É™„Ç¢
        this.elements.clearHistoryBtn.addEventListener('click', () => this.clearHistory());
        
        // „É¢„Éº„ÉÄ„É´Â§ñ„ÇØ„É™„ÉÉ„ÇØ
        this.elements.gameOverModal.addEventListener('click', (e) => {
            if (e.target === this.elements.gameOverModal) {
                this.closeModal();
            }
        });
    }
    
    changeDifficulty() {
        const difficulty = this.elements.difficulty.value;
        this.gameState.difficulty = difficulty;
        
        const config = this.difficulties[difficulty];
        this.gameState.maxRange = config.max;
        this.gameState.maxAttempts = config.attempts;
        
        this.elements.maxRange.value = config.max;
        this.elements.maxAttempts.value = config.attempts;
        
        this.updateRangeSettings();
        this.updateAttemptSettings();
    }
    
    updateRangeSettings() {
        const min = parseInt(this.elements.minRange.value);
        const max = parseInt(this.elements.maxRange.value);
        
        if (min >= max) {
            this.elements.maxRange.value = min + 1;
        }
        
        this.gameState.minRange = parseInt(this.elements.minRange.value);
        this.gameState.maxRange = parseInt(this.elements.maxRange.value);
        
        this.updateSettings();
    }
    
    updateAttemptSettings() {
        this.gameState.maxAttempts = parseInt(this.elements.maxAttempts.value);
        this.updateSettings();
    }
    
    updateSettings() {
        this.elements.rangeDisplay.textContent = `${this.gameState.minRange}„Äú${this.gameState.maxRange}`;
    }
    
    startGame() {
        this.gameState.secretNumber = Math.floor(Math.random() * (this.gameState.maxRange - this.gameState.minRange + 1)) + this.gameState.minRange;
        this.gameState.currentAttempts = 0;
        this.gameState.remainingAttempts = this.gameState.maxAttempts;
        this.gameState.isGameActive = true;
        this.gameState.guessHistory = [];
        this.gameState.hints = [];
        
        this.elements.gamePanel.style.display = 'block';
        this.elements.startBtn.textContent = '„Ç≤„Éº„É†‰∏≠...';
        this.elements.startBtn.disabled = true;
        this.elements.guessInput.disabled = false;
        this.elements.guessBtn.disabled = false;
        this.elements.guessInput.value = '';
        this.elements.feedback.textContent = '';
        this.elements.hintArea.innerHTML = '';
        
        this.updateDisplay();
        this.updateHistory();
        
        this.elements.guessInput.focus();
        this.showFeedback(`„Ç≤„Éº„É†ÈñãÂßãÔºÅ${this.gameState.minRange}„Äú${this.gameState.maxRange}„ÅÆÊï∞Â≠ó„ÇíÂΩì„Å¶„Å¶„Åè„Å†„Åï„ÅÑ`, 'info');
    }
    
    makeGuess() {
        if (!this.gameState.isGameActive) return;
        
        const input = this.elements.guessInput.value.trim();
        const guess = parseInt(input);
        
        if (!this.validateGuess(guess)) return;
        
        this.gameState.currentAttempts++;
        this.gameState.remainingAttempts--;
        
        const result = this.evaluateGuess(guess);
        
        // Â±•Ê≠¥„Å´ËøΩÂä†
        this.gameState.guessHistory.push({
            guess: guess,
            result: result,
            attempt: this.gameState.currentAttempts
        });
        
        this.updateDisplay();
        this.updateHistory();
        this.generateHints(guess);
        
        if (result === 'correct') {
            this.endGame(true);
        } else if (this.gameState.remainingAttempts <= 0) {
            this.endGame(false);
        } else {
            this.elements.guessInput.value = '';
            this.elements.guessInput.focus();
        }
        
        this.saveGameData();
    }
    
    validateGuess(guess) {
        if (isNaN(guess)) {
            this.showFeedback('ÊúâÂäπ„Å™Êï∞Â≠ó„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'error');
            return false;
        }
        
        if (guess < this.gameState.minRange || guess > this.gameState.maxRange) {
            this.showFeedback(`${this.gameState.minRange}„Äú${this.gameState.maxRange}„ÅÆÁØÑÂõ≤„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ`, 'error');
            return false;
        }
        
        // ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ
        if (this.gameState.guessHistory.some(item => item.guess === guess)) {
            this.showFeedback('„Åì„ÅÆÊï∞Â≠ó„ÅØÊó¢„Å´Êé®Ê∏¨Ê∏à„Åø„Åß„Åô', 'warning');
            return false;
        }
        
        return true;
    }
    
    evaluateGuess(guess) {
        const secret = this.gameState.secretNumber;
        
        if (guess === secret) {
            this.showFeedback('üéâ Ê≠£Ëß£„Åß„ÅôÔºÅ', 'correct');
            return 'correct';
        } else if (guess > secret) {
            const diff = guess - secret;
            if (diff <= 5) {
                this.showFeedback('üî• „Å®„Å¶„ÇÇËøë„ÅÑÔºÅ„ÇÇ„ÅÜÂ∞ë„ÅóÂ∞è„Åï„ÅÑÊï∞Â≠ó„Åß„Åô', 'close-high');
            } else if (diff <= 10) {
                this.showFeedback('üìâ Ëøë„ÅÑÔºÅÂ∞è„Åï„ÅÑÊï∞Â≠ó„Åß„Åô', 'near-high');
            } else {
                this.showFeedback('‚¨áÔ∏è „ÇÇ„Å£„Å®Â∞è„Åï„ÅÑÊï∞Â≠ó„Åß„Åô', 'too-high');
            }
            return 'too-high';
        } else {
            const diff = secret - guess;
            if (diff <= 5) {
                this.showFeedback('üî• „Å®„Å¶„ÇÇËøë„ÅÑÔºÅ„ÇÇ„ÅÜÂ∞ë„ÅóÂ§ß„Åç„ÅÑÊï∞Â≠ó„Åß„Åô', 'close-low');
            } else if (diff <= 10) {
                this.showFeedback('üìà Ëøë„ÅÑÔºÅÂ§ß„Åç„ÅÑÊï∞Â≠ó„Åß„Åô', 'near-low');
            } else {
                this.showFeedback('‚¨ÜÔ∏è „ÇÇ„Å£„Å®Â§ß„Åç„ÅÑÊï∞Â≠ó„Åß„Åô', 'too-low');
            }
            return 'too-low';
        }
    }
    
    generateHints(guess) {
        const secret = this.gameState.secretNumber;
        const hints = [];
        
        // Ê°ÅÊï∞„Éí„É≥„Éà
        if (this.gameState.currentAttempts >= 3) {
            const secretDigits = secret.toString().length;
            const guessDigits = guess.toString().length;
            
            if (secretDigits !== guessDigits) {
                hints.push(`<div class="hint"><span class="hint-icon">üî¢</span>Á≠î„Åà„ÅØ${secretDigits}Ê°Å„ÅÆÊï∞Â≠ó„Åß„Åô</div>`);
            }
        }
        
        // ÁØÑÂõ≤Áµû„ÇäËæº„Åø„Éí„É≥„Éà
        if (this.gameState.currentAttempts >= 5) {
            const history = this.gameState.guessHistory;
            const highs = history.filter(h => h.result === 'too-high').map(h => h.guess);
            const lows = history.filter(h => h.result === 'too-low').map(h => h.guess);
            
            if (highs.length > 0 && lows.length > 0) {
                const minHigh = Math.min(...highs);
                const maxLow = Math.max(...lows);
                hints.push(`<div class="hint"><span class="hint-icon">üéØ</span>Á≠î„Åà„ÅØ${maxLow}„Äú${minHigh}„ÅÆÈñì„Å´„ÅÇ„Çä„Åæ„Åô</div>`);
            }
        }
        
        // Â•áÊï∞ÂÅ∂Êï∞„Éí„É≥„Éà
        if (this.gameState.currentAttempts >= 7) {
            const isEven = secret % 2 === 0;
            hints.push(`<div class="hint"><span class="hint-icon">‚ö°</span>Á≠î„Åà„ÅØ${isEven ? 'ÂÅ∂Êï∞' : 'Â•áÊï∞'}„Åß„Åô</div>`);
        }
        
        if (hints.length === 0 && this.gameState.remainingAttempts <= 3) {
            hints.push(`<div class="hint"><span class="hint-icon">üí°</span>ÊÆã„Çä${this.gameState.remainingAttempts}ÂõûÔºÅÈ†ëÂºµ„Å£„Å¶ÔºÅ</div>`);
        }
        
        this.elements.hintArea.innerHTML = hints.join('');
    }
    
    showFeedback(message, type) {
        this.elements.feedback.textContent = message;
        this.elements.feedback.className = `feedback ${type}`;
        
        // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
        this.elements.feedback.style.animation = 'none';
        setTimeout(() => {
            this.elements.feedback.style.animation = 'feedbackPulse 0.5s ease';
        }, 10);
    }
    
    updateDisplay() {
        this.elements.currentAttempts.textContent = this.gameState.currentAttempts;
        this.elements.remainingAttempts.textContent = this.gameState.remainingAttempts;
        this.elements.totalWins.textContent = this.gameState.totalWins;
        this.elements.totalGames.textContent = this.gameState.totalGames;
        
        const winRate = this.gameState.totalGames > 0 ? 
            Math.round((this.gameState.totalWins / this.gameState.totalGames) * 100) : 0;
        this.elements.winRate.textContent = `${winRate}%`;
        
        if (this.gameState.isGameActive) {
            this.elements.gameStatus.textContent = `Ë©¶Ë°åÂõûÊï∞: ${this.gameState.currentAttempts}/${this.gameState.maxAttempts}`;
        }
    }
    
    updateHistory() {
        if (this.gameState.guessHistory.length === 0) {
            this.elements.historyList.innerHTML = '<p style="text-align: center; color: #999;">Êé®Ê∏¨Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
            return;
        }
        
        this.elements.historyList.innerHTML = this.gameState.guessHistory
            .slice(-10) // ÊúÄÊñ∞10‰ª∂
            .reverse()
            .map(item => `
                <div class="history-item ${item.result}">
                    <div class="history-attempt">${item.attempt}</div>
                    <div class="history-guess">${item.guess}</div>
                    <div class="history-result">
                        ${item.result === 'correct' ? 'üéØ Ê≠£Ëß£!' : 
                          item.result === 'too-high' ? 'üìâ Â§ß„Åç„ÅÑ' : 'üìà Â∞è„Åï„ÅÑ'}
                    </div>
                </div>
            `)
            .join('');
    }
    
    endGame(isWin) {
        this.gameState.isGameActive = false;
        this.gameState.totalGames++;
        
        if (isWin) {
            this.gameState.totalWins++;
            this.addToLeaderboard();
        }
        
        this.elements.startBtn.textContent = 'Êñ∞„Åó„ÅÑ„Ç≤„Éº„É†';
        this.elements.startBtn.disabled = false;
        this.elements.guessInput.disabled = true;
        this.elements.guessBtn.disabled = true;
        this.elements.gamePanel.style.display = 'none';
        
        this.updateDisplay();
        this.updateLeaderboard();
        this.showGameOverModal(isWin);
        this.saveGameData();
    }
    
    addToLeaderboard() {
        const score = {
            attempts: this.gameState.currentAttempts,
            range: `${this.gameState.minRange}-${this.gameState.maxRange}`,
            maxAttempts: this.gameState.maxAttempts,
            difficulty: this.gameState.difficulty,
            date: new Date().toLocaleDateString('ja-JP')
        };
        
        this.gameState.leaderboard.push(score);
        
        // Ë©¶Ë°åÂõûÊï∞„Åß„ÇΩ„Éº„ÉàÔºàÂ∞ë„Å™„ÅÑÊñπ„ÅåËâØ„ÅÑÔºâ
        this.gameState.leaderboard.sort((a, b) => a.attempts - b.attempts);
        
        // ‰∏ä‰Ωç10‰ª∂„Å´Âà∂Èôê
        this.gameState.leaderboard = this.gameState.leaderboard.slice(0, 10);
    }
    
    updateLeaderboard() {
        if (this.gameState.leaderboard.length === 0) {
            this.elements.leaderboardList.innerHTML = '<p style="text-align: center; color: #999;">„É™„Éº„ÉÄ„Éº„Éú„Éº„Éâ„ÅåÁ©∫„Åß„Åô</p>';
            return;
        }
        
        this.elements.leaderboardList.innerHTML = this.gameState.leaderboard
            .map((score, index) => `
                <div class="leaderboard-item">
                    <div class="leaderboard-rank">${index + 1}</div>
                    <div class="leaderboard-details">
                        <div class="leaderboard-attempts">${score.attempts}Âõû</div>
                        <div class="leaderboard-info">ÁØÑÂõ≤: ${score.range} (${score.difficulty})</div>
                        <div class="leaderboard-date">${score.date}</div>
                    </div>
                </div>
            `)
            .join('');
    }
    
    showGameOverModal(isWin) {
        this.elements.gameOverTitle.textContent = isWin ? 'üéâ „Ç≤„Éº„É†„ÇØ„É™„Ç¢ÔºÅ' : 'üòû „Ç≤„Éº„É†„Ç™„Éº„Éê„Éº';
        
        const winRate = this.gameState.totalGames > 0 ? 
            Math.round((this.gameState.totalWins / this.gameState.totalGames) * 100) : 0;
        
        this.elements.gameResult.innerHTML = `
            <div class="result-emoji">${isWin ? 'üéâ' : 'üòû'}</div>
            <h3>${isWin ? '„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ' : 'ÊÆãÂøµ„Åß„Åó„Åü...'}</h3>
            <p><strong>Á≠î„Åà:</strong> ${this.gameState.secretNumber}</p>
            <p><strong>Ë©¶Ë°åÂõûÊï∞:</strong> ${this.gameState.currentAttempts}Âõû</p>
            <p><strong>ÂãùÁéá:</strong> ${winRate}% (${this.gameState.totalWins}Âãù/${this.gameState.totalGames}Êà¶)</p>
            ${isWin ? `<p class="achievement">üèÜ ${this.gameState.currentAttempts}Âõû„ÅßÊ≠£Ëß£ÔºÅ</p>` : ''}
        `;
        
        this.elements.gameOverModal.classList.add('show');
    }
    
    playAgain() {
        this.closeModal();
        this.startGame();
    }
    
    closeModal() {
        this.elements.gameOverModal.classList.remove('show');
    }
    
    clearHistory() {
        if (confirm('Êé®Ê∏¨Â±•Ê≠¥„Å®„É™„Éº„ÉÄ„Éº„Éú„Éº„Éâ„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åô„ÅãÔºü')) {
            this.gameState.guessHistory = [];
            this.gameState.leaderboard = [];
            this.gameState.totalGames = 0;
            this.gameState.totalWins = 0;
            
            this.updateDisplay();
            this.updateHistory();
            this.updateLeaderboard();
            this.saveGameData();
            
            this.showFeedback('Â±•Ê≠¥„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü', 'info');
        }
    }
    
    validateInput() {
        const input = this.elements.guessInput.value;
        const guess = parseInt(input);
        
        if (input && (!isNaN(guess) && guess >= this.gameState.minRange && guess <= this.gameState.maxRange)) {
            this.elements.guessBtn.disabled = false;
        } else {
            this.elements.guessBtn.disabled = true;
        }
    }
    
    saveGameData() {
        const dataToSave = {
            totalGames: this.gameState.totalGames,
            totalWins: this.gameState.totalWins,
            leaderboard: this.gameState.leaderboard,
            difficulty: this.gameState.difficulty
        };
        
        try {
            localStorage.setItem('numberGuessingGameData', JSON.stringify(dataToSave));
        } catch (error) {
            console.error('„Éá„Éº„Çø‰øùÂ≠ò„Ç®„É©„Éº:', error);
        }
    }
    
    loadGameData() {
        try {
            const savedData = localStorage.getItem('numberGuessingGameData');
            if (savedData) {
                const parsedData = JSON.parse(savedData);
                this.gameState.totalGames = parsedData.totalGames || 0;
                this.gameState.totalWins = parsedData.totalWins || 0;
                this.gameState.leaderboard = parsedData.leaderboard || [];
                this.gameState.difficulty = parsedData.difficulty || 'normal';
                
                // Èõ£ÊòìÂ∫¶Ë®≠ÂÆö„ÇíÂæ©ÂÖÉ
                this.elements.difficulty.value = this.gameState.difficulty;
                this.changeDifficulty();
            }
        } catch (error) {
            console.error('„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
        }
        
        this.updateLeaderboard();
    }
}

// „Ç¢„Éó„É™ÂàùÊúüÂåñ
document.addEventListener('DOMContentLoaded', () => {
    new NumberGuessingGame();
});